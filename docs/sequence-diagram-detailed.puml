@startuml MCI Framework Detailed Flow

title Springware MCI Framework - Detailed Protocol Flow

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

' Participants
actor "User" as User

box "Demo Layer" #E8F4FD
    participant "BankTcpClient\nBankHttpClient" as DemoClient
    participant "BankTcpServer\nBankHttpServer" as DemoServer
end box

box "Core Client" #E8F8E8
    participant "TcpClient / HttpClient" as CoreClient
    participant "CircuitBreaker" as CB
    participant "HealthChecker" as HC
end box

box "Common Layer" #FFF8E8
    participant "LayoutManager" as LayoutMgr
    participant "MessageLayout" as Layout
    participant "ProtocolConfig" as Protocol
end box

box "Core Server" #F8E8F8
    participant "TcpServer / HttpServer" as CoreServer
    participant "BizRegistry" as BizReg
    participant "Biz" as Biz
end box

== Initialization Phase ==

User -> DemoServer : start()
activate DemoServer

DemoServer -> CoreServer : new TcpServer(config) or\nnew HttpServer(config)
activate CoreServer

CoreServer -> LayoutMgr : registerLayouts(BAL1, BAL2, CRD1...)
note right: Load 17 YAML layouts\n(Banking + Card)

CoreServer -> BizReg : register("BAL1", BalanceInquiryBiz)
CoreServer -> BizReg : register("TRF1", TransferBiz)
CoreServer -> BizReg : register("CRD1", CardListBiz)
CoreServer -> BizReg : register("CUH1", CardUsageHistoryBiz)

alt TCP Server
    CoreServer -> CoreServer : Create Netty ServerBootstrap\nBind to port 9001/9011
else HTTP/HTTPS Server
    CoreServer -> CoreServer : Create HttpServer\nBind to port 9003/9443
end

CoreServer --> DemoServer : Server started
deactivate CoreServer
deactivate DemoServer

== Client Connection ==

User -> DemoClient : connect()
activate DemoClient

DemoClient -> CoreClient : connect(host, port)
activate CoreClient

CoreClient -> CB : isCallPermitted()
activate CB
CB --> CoreClient : true (CLOSED state)
deactivate CB

alt TCP Client
    CoreClient -> CoreClient : Create Netty Bootstrap\nConnect to server
else HTTP/HTTPS Client
    CoreClient -> CoreClient : Initialize HttpClient\nSetup SSL if HTTPS
end

CoreClient -> HC : start()
note right: Schedule heartbeat\nevery 30 seconds

CoreClient --> DemoClient : Connected
deactivate CoreClient
deactivate DemoClient

== TCP Message Flow (Fixed-Length Binary) ==

User -> DemoClient : balanceInquiry("1234567890123456789")
activate DemoClient

DemoClient -> DemoClient : Create Message\nmessageCode = "BAL1"

DemoClient -> CoreClient : send(message, timeout)
activate CoreClient

CoreClient -> LayoutMgr : getLayout("BAL1")
activate LayoutMgr
LayoutMgr --> CoreClient : MessageLayout
deactivate LayoutMgr

CoreClient -> Layout : encode(message, charset)
activate Layout

note right of Layout
  **TCP Binary Encoding:**
  msgCode  : "BAL1"     (4 bytes)
  orgCode  : "000"      (3 bytes)
  txDate   : "20240117" (8 bytes)
  txTime   : "143052"   (6 bytes)
  seqNo    : "0000000001" (10 bytes)
  accountNo: "1234567..." (20 bytes)
  Total: 70 bytes
end note

Layout --> CoreClient : byte[70]
deactivate Layout

CoreClient -> Protocol : prependLengthField(data)
note right: [0x00, 0x00, 0x00, 0x46] + [payload]

CoreClient ->> CoreServer : TCP Socket write\n[Length: 4B] + [Payload: 70B]
activate CoreServer

CoreClient -> CoreClient : pendingRequests.put(seqNo, future)\nfuture.get(timeout)

CoreServer -> CoreServer : LengthFieldBasedFrameDecoder\nExtract payload

CoreServer -> LayoutMgr : getLayout("BAL1")
CoreServer -> Layout : decode(payload, charset)
activate Layout
Layout --> CoreServer : Message request
deactivate Layout

CoreServer -> BizReg : getBiz("BAL1")
BizReg --> CoreServer : BalanceInquiryBiz

CoreServer -> Biz : execute(request, context)
activate Biz

Biz -> Biz : accountNo = request.getString("accountNo")\nbalance = repository.getBalance(accountNo)

Biz --> CoreServer : Message response\n{messageCode: "BAL2", rspCode: "0000", balance: 1000000}
deactivate Biz

CoreServer -> Layout : encode(response, charset)
Layout --> CoreServer : byte[85]

CoreServer ->> CoreClient : TCP Socket write\n[Length: 4B] + [Payload: 85B]
deactivate CoreServer

CoreClient -> Layout : decode(payload, charset)
Layout --> CoreClient : Message response

CoreClient -> CoreClient : future.complete(response)

CoreClient --> DemoClient : Message response
deactivate CoreClient

DemoClient --> User : {rspCode: "0000", balance: 1000000}
deactivate DemoClient

== HTTP/HTTPS Message Flow (JSON) ==

User -> DemoClient : balanceInquiry("1234567890123456789")
activate DemoClient

DemoClient -> DemoClient : Create Message\nmessageCode = "BAL1"

DemoClient -> CoreClient : send(message)
activate CoreClient

CoreClient -> CoreClient : Convert to JSON

note right of CoreClient
  **HTTP JSON Request:**
  POST /api/balance HTTP/1.1
  Content-Type: application/json

  {
    "messageCode": "BAL1",
    "fields": {
      "accountNo": "1234567890123456789"
    }
  }
end note

alt HTTPS
    CoreClient -> CoreClient : SSL/TLS Handshake\n(Self-signed cert trusted)
end

CoreClient ->> CoreServer : HTTP POST /api/balance
activate CoreServer

CoreServer -> CoreServer : Parse JSON request\nExtract messageCode

CoreServer -> LayoutMgr : getLayout("BAL1")
CoreServer -> Layout : fromJson(jsonFields)
Layout --> CoreServer : Message request

CoreServer -> BizReg : getBiz("BAL1")
BizReg --> CoreServer : BalanceInquiryBiz

CoreServer -> Biz : execute(request, context)
activate Biz
Biz --> CoreServer : Message response
deactivate Biz

CoreServer -> Layout : toJson(response)
Layout --> CoreServer : JSON fields

note right of CoreServer
  **HTTP JSON Response:**
  HTTP/1.1 200 OK
  Content-Type: application/json

  {
    "messageCode": "BAL2",
    "fields": {
      "rspCode": "0000",
      "accountNo": "1234567...",
      "balance": 1000000
    }
  }
end note

CoreServer ->> CoreClient : HTTP 200 OK + JSON
deactivate CoreServer

CoreClient -> CoreClient : Parse JSON response\nConvert to Message

CoreClient --> DemoClient : Message response
deactivate CoreClient

DemoClient --> User : {rspCode: "0000", balance: 1000000}
deactivate DemoClient

== Circuit Breaker Protection ==

note over CB
  **Circuit Breaker States:**
  CLOSED -> Normal operation
  OPEN -> Block all requests
  HALF_OPEN -> Test recovery
end note

User -> CoreClient : send() [Failure]
CoreClient -> CB : recordFailure()

loop Consecutive failures >= 5
    CoreClient -> CB : recordFailure()
end

CB -> CB : Transition to OPEN
note right: Block for 60 seconds

User -> CoreClient : send()
CB --> User : CircuitOpenException

... After 60 seconds ...

CB -> CB : Transition to HALF_OPEN
User -> CoreClient : send() [Test request]

alt Success
    CB -> CB : Transition to CLOSED
else Failure
    CB -> CB : Back to OPEN
end

@enduml
