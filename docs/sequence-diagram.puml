@startuml MCI Framework Message Flow

title Springware MCI Framework - Multi-Protocol Message Flow

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

' Participants - Banking
box "Banking Client" #E8FFE8
    participant "Application" as BankApp
    participant "BankTcpClient\nBankHttpClient" as BankClient
end box

' Participants - Card
box "Card Client" #FFF0E8
    participant "Application" as CardApp
    participant "CardTcpClient\nCardHttpClient" as CardClient
end box

box "Codec Layer" #LightGreen
    participant "LayoutManager" as LayoutMgr
    participant "MessageLayout" as MsgLayout
end box

box "Network" #LightGray
    participant "TCP/HTTP/HTTPS" as Network
end box

box "Banking Server" #E8FFE8
    participant "BankTcpServer\nBankHttpServer" as BankServer
    participant "BankBizRegistry" as BankBizReg
    participant "BalanceInquiryBiz\nTransferBiz" as BankBiz
end box

box "Card Server" #FFF0E8
    participant "CardTcpServer\nCardHttpServer" as CardServer
    participant "CardBizRegistry" as CardBizReg
    participant "CardListBiz\nCardUsageHistoryBiz" as CardBiz
end box

== Banking: Balance Inquiry (BAL1 -> BAL2) ==

BankApp -> BankClient : balanceInquiry(accountNo)
activate BankClient

BankClient -> BankClient : Create Message\n{messageCode: "BAL1"}

BankClient -> LayoutMgr : encode(message)
activate LayoutMgr

LayoutMgr -> MsgLayout : getLayout("BAL1")
LayoutMgr -> MsgLayout : encode(message)
activate MsgLayout

note right of MsgLayout
  TCP: Fixed-width binary
  HTTP: JSON format
end note

MsgLayout --> LayoutMgr : encoded data
deactivate MsgLayout

LayoutMgr --> BankClient : byte[] / JSON
deactivate LayoutMgr

BankClient -> Network : Send request
activate Network

Network -> BankServer : Receive request
deactivate Network
activate BankServer

BankServer -> LayoutMgr : decode(data)
LayoutMgr --> BankServer : Message request

BankServer -> BankBizReg : getBiz("BAL1")
activate BankBizReg
BankBizReg --> BankServer : BalanceInquiryBiz
deactivate BankBizReg

BankServer -> BankBiz : execute(request, context)
activate BankBiz

note right of BankBiz
  1. Get accountNo
  2. Query AccountRepository
  3. Build response (BAL2)
end note

BankBiz --> BankServer : Message response\n{messageCode: "BAL2"\n rspCode: "0000"\n balance: 1000000}
deactivate BankBiz

BankServer -> LayoutMgr : encode(response)
LayoutMgr --> BankServer : encoded response

BankServer -> Network : Send response
activate Network
deactivate BankServer

Network -> BankClient : Receive response
deactivate Network

BankClient -> LayoutMgr : decode(data)
LayoutMgr --> BankClient : Message response

BankClient --> BankApp : {rspCode: "0000", balance: 1000000}
deactivate BankClient

== Card: Card List Inquiry (CRD1 -> CRD2) ==

CardApp -> CardClient : cardListInquiry(customerId)
activate CardClient

CardClient -> CardClient : Create Message\n{messageCode: "CRD1"}

CardClient -> LayoutMgr : encode(message)
activate LayoutMgr

LayoutMgr -> MsgLayout : getLayout("CRD1")
LayoutMgr -> MsgLayout : encode(message)
activate MsgLayout

note right of MsgLayout
  Supports REPEATING fields
  for card list response
end note

MsgLayout --> LayoutMgr : encoded data
deactivate MsgLayout

LayoutMgr --> CardClient : byte[] / JSON
deactivate LayoutMgr

CardClient -> Network : Send request
activate Network

Network -> CardServer : Receive request
deactivate Network
activate CardServer

CardServer -> LayoutMgr : decode(data)
LayoutMgr --> CardServer : Message request

CardServer -> CardBizReg : getBiz("CRD1")
activate CardBizReg
CardBizReg --> CardServer : CardListBiz
deactivate CardBizReg

CardServer -> CardBiz : execute(request, context)
activate CardBiz

note right of CardBiz
  1. Get customerId
  2. Query CardRepository
  3. Build response with card list (CRD2)
end note

CardBiz --> CardServer : Message response\n{messageCode: "CRD2"\n rspCode: "0000"\n cardCount: 3\n cards: [...]}
deactivate CardBiz

CardServer -> LayoutMgr : encode(response)
LayoutMgr --> CardServer : encoded response

CardServer -> Network : Send response
activate Network
deactivate CardServer

Network -> CardClient : Receive response
deactivate Network

CardClient -> LayoutMgr : decode(data)
LayoutMgr --> CardClient : Message response

CardClient --> CardApp : {rspCode: "0000", cards: [...]}
deactivate CardClient

== Protocol Comparison ==

note over Network
  **TCP (Port 9001/9011)**
  - Fixed-length binary encoding
  - 4-byte length prefix (Big-Endian)
  - Persistent connection

  **HTTP (Port 9003/9013)**
  - JSON encoding
  - RESTful endpoints
  - Connection per request

  **HTTPS (Port 9443/9444)**
  - JSON encoding with TLS
  - Self-signed certificate support
  - Encrypted channel
end note

@enduml
